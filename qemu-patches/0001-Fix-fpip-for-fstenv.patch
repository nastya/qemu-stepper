From a781078f8977274425c4f14c2b17f72e0a5f73f5 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=D0=90=D0=BD=D0=B0=D1=81=D1=82=D0=B0=D1=81=D0=B8=D1=8F=20=D0?=
 =?UTF-8?q?=A9=D0=B5=D1=80=D0=B1=D0=B8=D0=BD=D0=B8=D0=BD=D0=B0?= <nastya_jane@mail.ru>
Date: Tue, 26 Apr 2011 22:22:26 +0400
Subject: [PATCH 1/2] Fix fpip for fstenv.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit


Signed-off-by: Сковорода Никита Андреевич <chalkerx@gmail.com>
---
 target-i386/cpu.h       |    1 +
 target-i386/helper.h    |    2 ++
 target-i386/op_helper.c |    9 +++++++--
 target-i386/translate.c |    1 +
 4 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/target-i386/cpu.h b/target-i386/cpu.h
index c7047d5..2cada6e 100644
--- a/target-i386/cpu.h
+++ b/target-i386/cpu.h
@@ -642,6 +642,7 @@ typedef struct CPUX86State {
     uint16_t fpuc;
     uint8_t fptags[8];   /* 0 = valid, 1 = empty */
     FPReg fpregs[8];
+    target_ulong fpip;
 
     /* emulator internal variables */
     float_status fp_status;
diff --git a/target-i386/helper.h b/target-i386/helper.h
index 6b518ad..26b47a3 100644
--- a/target-i386/helper.h
+++ b/target-i386/helper.h
@@ -3,6 +3,8 @@
 DEF_HELPER_FLAGS_1(cc_compute_all, TCG_CALL_PURE, i32, int)
 DEF_HELPER_FLAGS_1(cc_compute_c, TCG_CALL_PURE, i32, int)
 
+DEF_HELPER_1(save_fpip, void, tl)
+
 DEF_HELPER_0(lock, void)
 DEF_HELPER_0(unlock, void)
 DEF_HELPER_2(write_eflags, void, tl, i32)
diff --git a/target-i386/op_helper.c b/target-i386/op_helper.c
index 3c539f3..06cc3ad 100644
--- a/target-i386/op_helper.c
+++ b/target-i386/op_helper.c
@@ -120,6 +120,11 @@ static const CPU86_LDouble f15rk[7] =
 
 static spinlock_t global_cpu_lock = SPIN_LOCK_UNLOCKED;
 
+void helper_save_fpip(target_ulong fpip)
+{
+    env->fpip = fpip;
+}
+
 void helper_lock(void)
 {
     spin_lock(&global_cpu_lock);
@@ -4324,7 +4329,7 @@ void helper_fstenv(target_ulong ptr, int data32)
         stl(ptr, env->fpuc);
         stl(ptr + 4, fpus);
         stl(ptr + 8, fptag);
-        stl(ptr + 12, 0); /* fpip */
+        stl(ptr + 12, env->fpip); /* fpip */
         stl(ptr + 16, 0); /* fpcs */
         stl(ptr + 20, 0); /* fpoo */
         stl(ptr + 24, 0); /* fpos */
@@ -4333,7 +4338,7 @@ void helper_fstenv(target_ulong ptr, int data32)
         stw(ptr, env->fpuc);
         stw(ptr + 2, fpus);
         stw(ptr + 4, fptag);
-        stw(ptr + 6, 0);
+        stw(ptr + 6, env->fpip);
         stw(ptr + 8, 0);
         stw(ptr + 10, 0);
         stw(ptr + 12, 0);
diff --git a/target-i386/translate.c b/target-i386/translate.c
index 199302e..dbd6cfb 100644
--- a/target-i386/translate.c
+++ b/target-i386/translate.c
@@ -5952,6 +5952,7 @@ static target_ulong disas_insn(DisasContext *s, target_ulong pc_start)
                 goto illegal_op;
             }
         }
+        gen_helper_save_fpip(tcg_const_tl(pc_start - s->cs_base));
         break;
         /************************/
         /* string ops */
-- 
1.7.5.1

